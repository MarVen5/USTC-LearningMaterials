# 网络层：控制面

## 概述

1. 网络层的功能：选路 (控制面) 和转发 (数据面)

2. 两种建立控制面的方法
   - pre-router control
   - logically centralized control

## 选路算法

1. 选路问题：给定一组路由器和连接路由器的链路，寻找一条从源路由器到目的路由器的最佳路径

2. 最佳路径
   - 路径：分组从源节点到达目的节点所经过的节点序列
   - 评价一条路径的好坏可能包括：路径长度、数据速率、分组延迟、通信费用、安全性等
   - ISP 关心一些全局性指标：网络吞吐量最大、平均包延迟最小、平均通信费用最低、完了过负载均衡、路由稳定健壮
   - 路由评价指标通常是矛盾的，需要折衷

3. 图抽象

4. 选路算法分类
   - 全局 (所有路由器具有关于拓扑和链路代价的全部信息，集中式计算)/分布式 (路由器仅知道邻居节点以及到邻居节点的链路代价，通过与邻居交换信息，进行迭代计算) 
   - 静态 (路由随时间不变或缓慢变化，手工配置)/动态 (路由器根据拓扑及链路代价变化而自动更新路由)

### 链路状态 Link State 选路算法

1. 链路状态选路算法为全局算法，基本思想为每个节点利用可靠方法获得全网拓扑信息，抽象成一个带权拓扑图，计算到各个节点的最短路径

2. 五个步骤
   - 发现邻居：有链路直接相连的节点为邻居
   - 探测链路代价：探测到每个邻居的代价
   - 构造链路状态分组：利用邻居及链路代价信息
   - 扩散链路状态分组：向网络中所有节点发送 LS 分组
   - 计算路由：利用收到的 LS 分组构造网络拓扑，计算从本节点到其他各个节点的最短路径

### 距离矢量算法

1. Bellman-Ford 方程： $d_x(y)=\min_p\{c(x,p)+d_p(y)\},p\in N(x)$

2. 距离矢量算法：利用 Bellman-Ford 方程求解任意两个节点之间的最小代价路径，主要在于给出分布式求解 Bellman-Ford 方程的方法
   - 节点 x 测量到各个邻居 v 的链路代价
   - 节点 x 估计到达各个节点 y 的最小代价，构成距离矢量 $D_x=\{d_x(y),y\in N\}$
   - 每个节点 x 周期性将距离矢量发送给邻居
   - 节点 x 拥有每个邻居的距离矢量
   - 根据邻居的距离矢量更新自己的距离矢量

3. 距离矢量算法是迭代的、异步的、分布式算法
   - 好消息传播快，坏消息传播慢
   - 坏消息传播慢，可能计数无穷，解决方案：毒性逆转，如果 z 选择经过 y 到达 x，则 z 向 y 通告距离矢量时，将 $D_z(x)$ 设置为无穷大

### 两种算法比较

1. 通信复杂度
   - 链路状态信息在全网传播
   - 距离矢量仅发送给邻居

2. 收敛速度
   - 链路状态需要发送 $O(|N||E|)$ 个报文，时间复杂度 $O(N^2)$
   - 距离矢量差异大，可能出现路由环路

3. 健壮性
   - 链路状态：节点仅传播可靠信息即亲自测量的本地链路代价，节点计算的路由不传播，错误不扩散
   - 距离矢量：邻居的距离矢量可能不正确，节点计算的路由要传播，可能扩散错误

## 选路协议

1. 之前的选路算法中假设路由器运行相同的选路算法，且网络是平面结构的 (选路信息在全网扩散)，但真实情况下，因特网中数十亿的目的节点无法放进路由表，因此需要选路协议，也不是平面结构的 (平面结构不具有扩放性)，同时管理员可能希望对网络有更多的控制权

2. 自治系统 Autonomous System (AS)：由同一个管理域下的网络和路由器的结合，ICANN 分配一个 AS 编号
   - 域内选路 intra-AS/内部网关协议 Interior Gateway Protocol：在 AS 内部进行的选路，同一个 AS 内的路由器必须运行相同的选路协议，不同 AS 的路由器可以运行不同的选路协议
   - 域间选路 inter-AS/外部网关协议 Exterior Gateway Protocol：在 AS 之间进行的选路，网关路由器之间运行域间选路协议，所有的 AS 必须运行相同的域间选路协议
   - 网关路由器：在一个 AS 内部，直接连接到其他 AS 的路由器

3. 选路算法与选路协议
   - 选路算法是选路协议的一部分
   - 选路协议还包括路径代价的定义、报文格式、报文传输、报文处理、异常事件处理等

### 域内选路协议：*RIP*

1. Routing Information Protocol 采用距离矢量算法
   - 距离大家用跳数衡量，相邻路由器之间的链路为一跳，路径的跳数为从源路由器到目的子网 (含)经过的子网数量
   - 限定一条路径的最长距离为 15 跳
   - 距离向量封装在 RIP 响应报文中传输，也称 RIP 通告
   - 封装在 UDP 报文中发送，使用 UDP 端口 520，RIP 是一个应用层协议
   - 相邻路由器大约每 30 秒交换一次 RIP 响应报文

2. RIP 链路失效与恢复
   - 若超过 180 秒为收到某个邻居的 RIP 通告，认为该邻居不可达，设置距离为 16
   - 采用毒性逆转解决计数至无穷问题

### 域内选路协议：OSPF

1. Open Shortest Path First 采用链路状态算法
   - OSPF 没有规定代价怎么取，由管理员配置
   - 为了使路由相对稳定，通常选取不随负载变化的链路特性为代价
   - 链路代价通常反映管理员的选路策略，对偏好的链路将代价设置小一些
   - 实际应用中通常会选若干条路径，每条路径设置一定使用概率

2. OSPF 有 5 种分组类型，用于探测邻居、通告链路状态等
   - OSPF 分组封装在 IP 包中传输，协议号为 89
   - 路由器周期性地、或在链路状态改变时发送 OSPF 通告
   - OSPF 协议负责链路通告分组在网络中的广播及可靠传输
   - 路由器根据收到的链路通告分组构造链路状态数据库，然后计算以本路由器为根的最短路径树

3. OSPF 先进特性
   - 安全：所有报文都要被鉴别
   - 允许有多条相同代价的路由
   - 支持多播
   - 较大的 AS 中可以使用分层 OSPF

4. 分层选路
   - 一个 AS 内部可以分成多个区域
   - 每个区域运行自己的 OSPF 协议
   - 区域内部的链路状态仅在区域内传播
   - 区域边界路由器负责区域间的选路，将本区域的选路信息汇总（子网及路径代价），通告给其它区域；将收到的其它区域的选路信息（子网及路径代价）通告给本区域的内部路由器
   - 去往其它区域的分组，首先被发送给本地区域边界路由器，在主干上转发到目的区域边界路由器，然后再转发到目的子网
   - 一个特殊区域称为主干，所有区域必须连到主干上，主干的区域标识为 0
   - 路由器分为区域边界路由器、主干路由器、内部路由器，区域边界路由器都是主干路由器

## 域间选路协议

1. 域间选路协议任务：一个域的网关路由器需要了解哪些目的网络通过自己可达，将可达性信息传播到域内部所有路由器

2. 热土豆协议：域内路由器选择离自己最近的网关路由器

### 域间选路协议：EGP

1. 域间选路困难
   - 因特网规模极其庞大且结构复杂
   - 每个 AS 有自己的内部路由协议，使用自己的路由测度确定到目的网络的最佳路由，不同网络判断最佳路由的标准不同
   - AS 可能不信任来自某个 AS 的选路信息
   - AS 可能不愿意为其他 AS 转发数据包

2. 域间选路目标
   - AS 间选路试图找到能够可以到达目的网络的路由，不强求最佳路由

3. BGP：glue that holds the Internet together
   - 每个子网都可以在因特网上发布自己的存在
   - BGP 使得每个 AS 可以从邻居 AS 获得到其他子网的可达性信息
   - BGP 使得每个 AS 可以将其他网络的可达性信息传播到所有的内部路由器
   - BGP 使得每个 AS 可以基于可达性信息和策略确定到其他网络的好路由

4. BGP 对等方
   - 一对 AS 同意交换选路信息时，每个 AS 指定一个接近 AS 边缘的路由器使用 BGP 协议交换选路信息
   - 运行 BGP 协议的边界路由器称为 BGP speaker
   - 一对 BGP speaker 通过一条半永久的 TCP 连接 (端口号 179) 建立 BGP 会话，交换 BGP 报文，因此 BGP 是应用层协议
   - BGP 会话的两个端点互为 BGP 对等方

5. BGP 会话
   - 不同 AS 的边界路由器之间建立的 BGP 会话，称为外部 BGP (eBGP) 会话
   - 一个 AS 可能有多个边界路由器，这些边界路由器必须通过半永久 TCP 连接构成全连通，它们之间的 BGP 会话，称为内部 BGP (iBGP) 会话

6. 路径广告
   - BGP 会话交换的最重要内容是可达性信息
   - 路径广告是以 AS 枚举形式通告的、到达目的网络前缀的完全路径 (为便于检测出路径环路)

7. 基于策略的路由
   - 入境过滤：根据输入策略，对每条新的路由进行入境过滤；丢弃/按原样接受/接受但修改某些属性 (偏好度等)
   - 路径选择：对每个目的前缀，从所有可达路径中按照 BGP 指定的决策顺序确定一条最佳路由
   - 出境过滤：根据输出策略，决定是否向其邻居 AS 发布某条路径

## *广播选路*

1. 广播：将数据包从源节点发给所有节点
   - 可以用多次单播实现广播 (在源节点上复制分组)，缺点是低效 (相同分组在某些链路上重复传输) 以及源节点需要知道所有目的节点的地址
   - 理想的情况是源节点不需知道其他节点地址，将分组的目的地址设置为广播地址，路由器就负责将它转发到全网 (在网络中复制分组)，产生的分组拷贝最少

2. 网络中复制分组
   - 洪泛：收到广播分组后，在除了到来的剩下链路上发送分组的拷贝，缺点是如果有环会无休止循环，浪费资源
   - 受控洪泛：每个路由器仅转发之前未转发过的广播分组，可以记录分组 ID (OSPF 使用，因为 OSPF 就是用于生成后面的单播转发表，所以必须先记录) 或是使用反向路径转发 (仅转发从本节点到源节点的反向路径上到来的广播分组)

3. 反向路径转发 Reverse Path Forwarding
   - 广播分组到达路由器时，检查源地址与输入端口
   - 查找单播转发表，找到去往该源地址的转发表项
   - 如果输入端口与去往该源地址的输出端口相同，则扩散分组，否则丢弃
   - 算法合理、易于实现且开销不大

4. 生成树方法
   - 首先构造一个网络的生成树，路由器知道自己的哪几个端口在生成树上，当从一个端口收到广播分组后，只在属于生成树的其他端口上转发分组
   - 基于生成树的广播不会产生冗余分组拷贝
   - 生成树的构造基于核心：选择一个节点作为核心，称为汇聚点，其他节点向核心发送单播的加入报文，记录报文的输入端口和输出端口，这些端口就是位于生成树上的端口，加入报文到达生成树上的一个节点时，报文经过路径被添加到生成树上

## *多播选路*

1. 多播：将分组交付给一组接收者的通信模式
   - 因特网为这组接收者分配一个标识 (多播组标识)，使用 D 类地址作为多播组标识
   - 将分组的目的地址设置为其接收者的多播组地址
   - 接收者的 IP 地址与多播组地址无关，接收者可以在任何时候加入或离开多播组
   - 多播组管理协议 IGMP 允许主机向本地路由器申请加入或离开多播组
   - 多播选路协议协调多播路由器建立到达所有接收者的路径树

2. 多播选路
   - 为每个组建立多播转发树
   - 每个组成员应当只收到多播分组的一个拷贝
   - 非本组成员不应收到多播分组
   - 从源节点到每一个组成员节点的路径应当是最佳的

3. 建立多播树
   - 基于源：源节点建立一棵到达多播组所有成员的最短路径树，总是使用最佳路径转发分组，但路由器需要维护大量的多播树信息
   - 组共享树：每个多播组使用一棵树，树根为多播组的核心，源节点先发给核心，核心再在多播树上发送，每个组只需维护一棵多播树，但使用的路径可能不是最佳的

4. 基于源的树：最短路径树
   - MOSPF (多播 OSPF) 通过扩展 OSPF 协议实现最短路径多播选路
   - 扩展链路状态，包含链路上的组成员关系
   - 所有参与多播的主机在局域网上定期通报其所属的多播组 (IGMP)
   - 路由器将多播组集合页作为链路状态在网上广播 (MOSPF)
   - 路由器收到多播组集合页后，计算到达每个多播组的最短路径树 (按需计算)

5. 基于源的树：距离矢量多播选路
   - 扩展 RIP 协议的困难：除了边缘路由器外，其他路由器不知道多播组的存在
   - DVMRP 采用广播+剪枝方法
   - 反向路径转发来广播，确保多播分组到达每一个局域网
   - 路径剪枝，路由器删除不包含组成员的路径分支

6. 组共享树：基于核心的树
   - 指定一个路由作为核心，所有路由器要知道核心所属的组和单播 IP 地址，需要其他机制
   - 多播路由器向核心发送单播加入报文，报文到达核心或已在树上的节点时，报文经过路径加入树中
   - 多播分组的目的地址为多播组，从源节点到核心不能采用多播发送，多播分组只能从核心开始发送
   - 建立隧道：源节点将多播分组封装到单播分组中传输到核心，源节点和核心为隧道两个端点

7. 因特网的多播选路协议
   - 第一个用于因特网的多播选路协议是 DVMRP
   - 最广泛使用的是 PIM Protocol-Independent Multicast，不依赖于网络中使用的单播选路协议

8. PIM 两种工作模式
   - 稠密模式：许多路由器涉及多播，使用广播+剪枝
   - 稀疏模式：小部分路由器涉及多播，采用组共享树，流量很高时切换到源树

9. 多播分组穿越单播网络
   - 在多播路由器之间建立隧道，多播分组封装在单播分组中传输

10. 因特网多播骨干网
    - 因特网上的多播路由器以及多播路由器之间的隧道构成多播骨干网
    - MBONE Multicast BONE 是因特网上的第一个多播骨干网，1992 年构建
    - Internet2 主干网是目前使用最多的多播骨干网

## ICMP

1. Internet Control Message Protocol
   - 主机或路由器使用 ICMP 协议传递网络层上的一些信息
   - 包括询问和错误报告两类，询问用于请求信息，采用请求-响应模式；错误报告向源节点报告错误信息，不需响应
   - ICMP 报文封装在 IP 包中传输，ICMP 报文可能需要经过多个网络才能到达源节点，跨网络传输必须借助 IP 包

2. ICMP 错误报告
   - 源抑制：路由器缓存满，无法容纳新到的数据报
   - 超时：TTL 减为 0
   - 目的不可达：判断一个数据报不可能到达目的地
   - 重定向：发现路由有错或不是最佳路由
   - 参数错误：某个参数有错

3. ICMP 信息查询
   - 回声请求/响应
   - 地址掩码请求/响应
   - 路由器请求
   - 路由器发现

4. 报文格式：type, code, checksum, 内容

5. Ping 利用 ICMP 报文测试目的主机是否活跃以及去往目的主机的路径是否正常
   - 源主机发送 Echo Request 报文
   - 目的主机收到后发回 Echo Response 报文
   - 源主机计算 RTT，报告
   - 如果连续几次超时，报告目的不可达

6. Traceroute 利用 ICMP 测试到达目的主机的路由
   - 从 TTL 为 1 开始，每次加 1，向目的主机发送一个 Echo Request 报文
   - 中间路由器发回 TTL expired 报文
   - 直到收到目的主机的 Echo Response 报文

7. ICMPv6
   - 合并了 IPv4 中的 ARP 和 IGMP，并取消了 RARP
   - 仍然使用差错报告和查询两类报文
   - 差错报告去除源抑制报文：优先级和流标签允许路由器控制拥塞，丢弃不太重要的数据包；增加 Packet Too Big 报文：路由器丢弃长度超过 MTU 的包
   - 信息查询去掉不必要的查询报文，增加查询报文，用于实现 ARP 和 IGMP 功能