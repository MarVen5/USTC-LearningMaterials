# 无线和移动网络

1. 无线上网的设备数量已与有线上网的设备数量相当，但 **无线** 链路通信给物理层和数据链路层带来很多问题，且终端改变网络接入点 (**移动**)，给网络层带来很大问题

2. 无线网络的组成
   - 无线终端：笔记本、PDA、手机，运行网络应用，可能静止或移动 (无线不一定移动)
   - 基站：通常连接到固定网络，在无线终端和固定网络之间中继数据包，通常负责协调与之关联的多个无线主机的传输
   - 无线里娜鲁：连接无线终端和基站，需要 MAC 协议协调无线链路的使用，不同的无线链路具有不同的数据速率和传输距离

3. 无线网络的运行模式
   - 基础设施模式：无线终端通过基站连接到固定网络，所有传统的网络服务由固定网络提供
   - 自组织模式：网络中没有基站，节点只能与通信范围内的节点通信，节点相互帮助转发分组，每个节点既是终端又是路由器

4. 无线网络的分类
   - 有/无基础设施，单/多跳
   - 单跳，有基础设施：Wi-Fi，蜂窝网络
   - 单跳，无基础设施：蓝牙网络
   - 多跳，有基础设施：无线网状网
   - 多跳，无基础设施：自组织网络、车载网

## 无线链路

1. 无线链路的特性导致无线链路的传输距离受限，误码率很高
   - 信号衰减：信号在传播过程中能量逐渐减少 (路径损耗)
   - 干扰：受到其他信号源的干扰
   - 多径传播：由于地面或物体的反射作用，信号沿多条不同长度的路径到达接收端

2. 无线网络中信道冲突问题
   - 隐藏节点问题
   - 暴露节点问题

3. CSMA 在多跳无线网络中作用受限
   - 通过载波侦听，发送节点只能知道其周围是否有节点在发送，但真正影响此次通信的是接收节点周围是否有节点在发送
   - 隐藏节点：不在发送节点的通信范围内，但在接收节点通信范围内的活跃节点
   - 暴露节点：在发送节点通信范围内，但不在接收节点通信范围内的活跃节点

## IEEE 802.11 无线局域网 (Wi-Fi)

1. IEEE 802.11 无线局域网是一个协议族
   - 均使用 CSMA/CA 作为 MAC 协议
   - 都支持基站模式和自组织模式
   - 物理层不同 (频段、速率)

2. IEEE 802.11 无线局域网架构
   - 基本组成单元是基本服务集 (BSS)，由一个无线接入点 (AP) 和若干无线终端组成
   - 每个无线接口 (AP 和无线终端) 均有一个全局唯一的 MAC 地址
   - AP 的有线端口没有 MAC 地址 (AP 对路由器透明)

3. 信道与关联
   - 每个 BSS 分配一个信道，管理员安装 AP 时，为 AP 分配一个服务集标识符 SSID，并选择一个信道
   - 相邻 AP 使用的信道可能相互干扰
   - 主机必须与一个 AP 关联，扫描信道，监听各个 AP 发送的信标帧 (包含 AP 的 SSID 和 MAC 地址)，选择一个 AP 进行关联，使用 DHCP 获取 AP 所在子网中的一个 IP 地址

4. 主动/被动扫描
   - 被动扫描：主机监听信标帧，选择一个 AP 发送关联请求帧，AP 发送关联响应帧
   - 主动扫描：主机广播探测请求帧，AP 发送探测响应帧，主机选择一个 AP 发送关联请求帧，AP 发送关联响应帧

5. IEEE 802.11 的 MAC 协议
   - 采用 CSMA：发送前监听信道，不与当前进行的发送冲突
   - 发送过程中不检测冲突，因为发送过程中检测冲突很难 (接收信号的强度远小于发送信号的强度) 且不能检测出所有的冲突 (存在隐藏节点)
   - 使用链路层确认，接收方收到帧后需发送确认帧，以便发送方知道是否发送成功
   - 因此是避免冲突，CSMA/C(ollision)A(voidance)

6. IEEE 802.11 的操作模式
   - PCF 模式 (可选)，用于有基础设施的无线网络，基站控制单元内的所有通信活动，使用轮询，基站依次询问单元中的节点，被询问到的节点可以发送它们的帧，不会有冲突发生
   - DCF 模式：可用于有基础设施和无基础设施的无线网络，所有节点 (AP 和无线终端) 使用 CSMA/CA 协议竞争信道，支持信道预约机制 (可选) 和无信道预约的机制

7. 使用信道预约机制的 CSMA/CA
   - A 向 AP 发送一个 RTS 帧，帧中给出随后要发送的数据帧及 ACK 帧需要的总时间
   - AP 收到后回复一个 CTS 帧，帧中给出同样的时间
   - A 收到 CTS 帧后，发送数据帧
   - AP 收到帧后，发送一个 ACK 帧进行确认
   - 收到 RTS 帧及 CTS 帧的节点均沉默指定时间，让出信道使 A 和 AP 完成发送
   - 若 A 和 B 同时发送 RTS 帧，产生冲突，不成功的发送方随机等待一段时间后重试
   - 发送数据少时，一般不使用信道预约机制

8. 帧间距机制
   - SIFS：允许正处于会话中的节点优先发送，如收到 RTS 的节点发送一个 CTS，收到数据帧的节点允许发送一个 ACK 帧
   - PIFS：如果在 SIFS 后没有节点发送，PCF 模式的基站可以发送一个信标帧或轮询帧
   - DIFS：如果 PIFS 后没有基站发送，任何节点可以竞争信道
   - EIFS：如果以上间隔都没有发送，收到坏帧或未知帧的节点可以发送一个错误报告帧

9. 不使用信道预约机制的 CSMA/CA，如果有多个节点等待发送，随机选取的回退值确定发送顺序
   - 当节点有帧要发送时，侦听信道
   - 若一开始就侦听到信道空闲，等待 DIFS 时间后发送帧
   - 若没有，则选取一个随机回退值，侦听到信道空闲时递减；若过程中又侦听到信道忙，冻结计数值
   - 计数值减为 0 时，发送整个帧等待确认
   - 收到确认帧，表明发送成功，重置计数器；未收到确认帧，表明发送失败，重置计数器到一个更大的随机值

10. CSMA/CA 与 CSMA/CD
    - CSMA/CA 在发送过程中不检测冲突，使用确认机制；CSMA/CD 在发送过程中检测冲突，不使用确认机制
    - CSMA/CA 节点侦听到信道空闲后随机回退 (冲突损害很大，尽量避免)；CSMA/CD 节点侦听到信道空闲时立即发送 (不怕冲突，冲突后可以立即停发，损失不大)

11. IEEE 802.11 终端在子网中移动
    - 切换：终端从一个 BSS 移动到另一个 BSS
    - 发生切换时，终端要关联到新的 AP 上，终端检测到来自原来的 AP 的信号逐渐减弱时，开始扫描新的信标帧；收到新的 AP 发送的信号更强的信标帧时，先解除与原 AP 的关联，然后关联到新的 AP 上
    - 发生切换时，交换机中的转发表也需要更新，交换机通过自主学习更新转发表，交换机收到来自一个终端发送的帧时，更新终端所在端口；若转发表未及时更新，可能产生丢包
    - 若主机停留在同一个 IP 子网中，IP 地址保持不变
    - 切换过程中，终端上的应用正常运行，IP 地址没变，网络层及以上感觉不到；切换产生的延迟及丢包，在上层协议看来是正常的

12. IEEE 802.11 先进功能
    - 速率适应：主机移动或信噪比变化时，基站和主机动态改变传输速率 (物理层调制技术)
    - 功率管理：节点设置功率管理比特，告知 AP 它将进入休眠状态，节点进入休眠，在下一个信标帧前醒来，节点休眠期间，AP 缓存发往该节点的帧，AP 在发送的信标帧中包含一个移动节点列表，告知节点有哪些帧缓存在 AP 中，列表中的节点向 AP 请求帧，其余节点重新进入休眠状态

## 移动网络原理：编址和选路

1. 终端在 IP 子网间移动
   - 终端进入新的子网后，必须分配该子网上的一个地址 (DHCP)，并使用新的地址通信，此时不能保留原来的 IP 地址
   - 改变 IP 地址后，终端运行的应用将中断，因为通信对方不知道终端新地址，及时获知新地址，也需要重新建立连接，因为通信的套接字改变了

2. 移动网络术语
   - 归属网络：移动节点的永久居所
   - 永久地址：移动节点在归属网络中的地址，总是使用这个地址与移动节点通信
   - 归属代理：移动节点在外地时，为移动节点执行移动管理功能的实体
   - 永久地址：保持不变
   - 外地网络：移动节点当前网络
   - 转交地址：移动节点在外地网络上的地址
   - 通信者：希望与移动节点通信的节点
   - 外地代理：外地网络上为移动节点执行移动管理功能的实体

3. 移动节点注册
   - 移动终端向归属代理通报其在外地网络的新地址
   - 注册完成后，外地代理知道移动节点在本地网络上；归属代理知道移动节点的转交地址，记录到地址绑定表中

4. 间接选路到移动节点
   - 移动节点使用两个地址，永久地址和转交地址
   - 当通信者和移动节点在同一个网络中，依然要经过归属网络再转发到移动节点就很低效

5. 间接选路：终端在外地网络间移动
   - 节点移动到另一个网络，要向新的外地代理注册，新的外地代理向归属代理注册，归属代理更新移动节点的转交地址，归属代理使用新的转交地址向移动节点转发包
   - 节点移动及变换外地网络对通信者透明，移动节点的通信断点没有改变，正在进行的通信可以保持

6. 直接选路
   - 可以克服三角选路问题
   - 但对通信者不透明，通信者需要知道移动节点的转交地址，通信者需要增加对移动通信的支持

## 移动 IP

1. 移动 IP 是支持移动性的因特网体系结构与协议
   - 具有许多特性：归属代理、永久地址、转交地址、移动节点注册
   - 标准化三个部分：代理发现，移动节点注册，数据报间接选路

2. 代理发现
   - 愿意充当归属代理或外地代理的路由器定期在网络上发送代理通告，宣布自己的存在及 IP 地址
   - 愿意充当外地代理的路由器在代理通告中会提供一个或多个转交地址 (通常使用自己的 IP 地址作为转交地址)
   - 移动节点通过接收和分析代理通告，判断自己是否处于外地网络以及是否切换了网络
   - 如果发现在外地网络上，移动节点从外地代理提供的转交地址中选择一个作为自己的转交地址

3. 移动主机注册
   - 移动节点向外地代理发送一个注册请求，给出自己的永久地址、转交地址、归属代理地址以及认证信息等
   - 外地代理记录相关信息，向归属代理转发注册请求
   - 归属代理处理注册请求，若认证通过，将移动节点的永久地址及转交地址保存到绑定表中，发回一个注册响应
   - 外地代理收到有效的注册响应后，将移动节点记录在自己的转发表中，向移动节点转发注册响应
   - 当移动节点回到归属网络时，要向归属代理注销

4. 数据报间接选路
   - 数据包首先被归属代理得到
   - 归属代理查找地址绑定表，获得移动节点当前的转交地址
   - 归属代理将数据包发送到转交地址
   - 外地代理将数据包转发给移动节点

## 移动和上层协议

1. 无线和移动对上层协议的影响
   - 无线链路带来问题：误码率高，丢包率高，延迟增大
   - 节点移动带来问题：丢包，延迟增大
   - 逻辑上，没有什么影响，为上层协议提供的仍是尽力而为的服务，因此 TCP 和 UDP 也可以运行在无线网络上
   - 性能上，有很大影响，丢包率升高，传输延迟增大，TCP 将丢包解释为拥塞，会不必要地减小拥塞窗口，导致应用吞吐率很低，无线链路/有线无线混合链路上的 TCP 拥塞控制很难

