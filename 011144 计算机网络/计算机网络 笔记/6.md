# 数据链路层和局域网

## 概述

1. 链路层：将数据报从一个节点传输到相邻的下一个节点
   - 网络层：确定下一跳路由器，将数据报从输入端口转移到输出端口
   - 物理层：多种类型的传输媒体，传输原始比特流 (无结构)，容易产生传输错误


2. 一些术语
   - 节点：主机和路由器统称为节点
   - 链路：连接相邻节点的通信信道，包括有线链路、无线链路、局域网
   - 帧：链路层分组成为帧

3. 链路层服务
   - 组帧 (基本服务)：将数据报封装到帧中 (加上帧头帧尾)，从原始比特流中提取出完整的帧
   - 链路接入 (广播链路需要)：在广播信道上协调各个节点的发送行为
   - 差错检测 (基本服务)：检测传输错误
   - 差错纠正 (可选)：不使用重传
   - 可靠交付 (部分协议提供)：依然可以使用停等、GBN、SR 来实现；低误码率链路 (光纤、双绞线) 上很少使用，高误码率链路 (无线链路) 应当使用
   - 流量控制：调节发送速度，避免接收节点缓存溢出；提供可靠交付的链路层协议，不需要专门的流量控制；不提供可靠交付的链路层协议，需要流量控制机制
   - 半双工和全双工：半双工通信时，提供收/发转换

4. 链路层的实现
   - 路由器：链路层在线卡中实现
   - 主机：链路层主体部分在网卡 (网络适配器) 中实现
   - 线卡/网络适配器连接物理媒体，还实现了物理层的功能
   - 链路层由软硬件实现：
     - 硬件：控制器芯片，组帧、链路接入、检错、可靠交付、流量控制
     - 软件：主机上的链路层软件，是与网络层间的接口，激活控制器硬件、响应控制器中断

5. 网络适配器间的通信
   - 发送侧：将数据报封装到帧中，生成校验比特，(可选) 执行可靠传输和流量控制
   - 接收侧：提取帧，检测传输错误，(可选) 执行可靠传输和流量控制，解封装数据报，交给上层协议

## 差错检测和差错纠正

1. 传输出错的类型
   - 单个错：随机信道热噪声，一次影响 1 位
   - 突发错：瞬间的脉冲噪声，一次影响多位，突发长度表示突发错影响最大数据位数

2. 差错控制编码类型
   - 检错码：只能检测出传输错误，不能确定出错位置，通常与反馈重传机制结合
   - 纠错码：能够确定错误位置并自行纠正的编码

3. 如何检测与纠正
   - 码字 (codeword)：由 m 比特数据加上 r 比特的冗余位 (校验位) 构成
   - 有效编码集：$2^m$ 个符合编码规则的码字组成
   - 检错：若收到的码字为无效码字，判定出现传输错误
   - 海明距离 (Hamming Distance)：两个码字的对应位取值不同的位数
   - 纠错：将收到的无效码字纠正到距其最近的有效码字
   - 检错码与纠错码的能力都有限

4. 编码集的检错与纠错能力
   - 编码集的海明距离：编码集中任意两个有效码字的海明距离的最小值
   - 检错能力：为检错出所有 d 比特错误，编码集的海明距离至少应为 d+1
   - 纠错能力：为纠正所有 d 比特错误，编码集的海明距离至少应为 2d+1

5. 差错检测的实施
   - 发送端对要保护的数据生成校验位 EDC，添加在帧头中
   - 接收端对收到的数据计算 EDC，与收到的校验位比较，若不同则判定出现传输错误

6. 奇偶校验
   - 单比特奇偶校验：可检测奇数个比特错误，检错率为 50%，编码集海明距离为 2
   - 二维奇偶校验：可检测 2 比特错和纠正单比特错误，编码集海明距离为 3，有利于检测突发错误

7. 循环冗余校验 CRC
   - 多项式编码，将位看成某个一元多项式的系数
   - 信息多项式 $M(x)$：由 $m$ 个信息比特为系数构成的多项式
   - 冗余多项式 $R(x)$：由 $r$ 个冗余比特为系数构成的多项式
   - 码多项式 $T(x)$：在 $m$ 个信息比特后加上 $r$ 个冗余比特构成码字对应多项式 $T(x)=x^r\cdot M(x)+R(x)$
   - 生成多项式 $G(x)$：双方确定用来计算 $R(x)$ 的一个多项式
   - 编码方法：$R(x)=x^r\cdot M(x)/G(x)$ 的余式，此处减法运算定义为异或操作
   - 检验方法：若 $T(x)/G(x)$ 的余式为 0，判定传输正确
   - CRC 码检错能力极强，可用硬件实现，链路层应用最广泛

## 多址接入协议

1. 链路类型
   - 点到点链路：仅连接一个发送方和一个接收方的链路，一条全双工链路可看成两条单工链路组成
   - 广播链路：连接许多节点的单一共享链路，任一节点发送的数据可被链路上其他节点接收到

2. 多址接入 (Multiple access)
   - 冲突：广播链路上，两个或多个节点同时发送，信号会发生干扰，导致接收失败
   - 多址接入协议：规定节点共享信道的方法，也称媒体接入控制 (Medium Access Control) 协议

3. 理想的多址接入协议
   - 只有一个节点发送时，应能以最高速率发送
   - 有 M 个节点发送时，每个节点平均能发送到 1/M 的速率
   - 协议是无中心的，不需要一个特殊节点协调发送，不需要时钟或时隙同步
   - 简单

4. MAC 分类
   - 信道划分：信道划分为若干子信道，每个节点固定一个子信道，不发生冲突；关注公平性，轻负载时信道利用率不高
   - 随机接入：不划分信道，每个节点自行决定何时发送，出现冲突后设法解决；轻负载时信道利用率高，高负载时冲突严重
   - 轮流使用信道：不划分信道，有数据的节点轮流发送，不发生冲突；信道利用率高，公平性好，但需要引入额外机制

### 信道划分的 MAC 协议

1. TDMA 时分多址
   - 信道的使用时间划分成帧，每个节点被分配一个固定长度的时间片，每个时间片可发送一个分组
   - 节点只能在分配给自己的时间片内发送
   - 节点不发送，时间片轮空

2. FDMA 频分多址
   - 信道频谱划分为多个子频带
   - 每个节点被分配一个固定的子频带
   - 节点不发送，子频带空闲

3. CDMA 码分多址
   - 将每个比特时间进一步划分为 m 个微时隙 chip
   - 每个节点被分配一个唯一的 m 比特码序列 chip code
   - 发送方编码：发送 1 就发送 chip code，否则发送 chip code 反码
   - 信号叠加：多个节点发送的信号在信道中线性相加
   - 接收方解码：用发送方的 chip code 与信道中收到的混合信号求内积，恢复出原数据
   - 前提条件：任意两个 chip code 必须是相互正交的
   - CDMA 允许所有节点同时使用整个信道

### 随机接入的 MAC 协议

1. 随机接入的基本思想
   - 当节点有数据要发送时，以信道速率 R 发送，发送前不需要协调
   - 随机接入 MAC 协议规定如何检测冲突，以及如何从冲突中恢复

2. 随机接入 MAC 协议包括
   - 发送前不监听信道 ALOHA 家族
   - 发送前监听信道 CSMA 家族

3. 时分 (Slotted) ALOHA
   - 规定
     - 所有帧长度相同
     - 时间被划分成等长时隙，每个时隙传一帧
     - 节点只能在时隙开始时发送
     - 节点是时钟同步
     - 所有节点可在时隙结束前检测到是否有冲突发生
   - 操作
     - 节点从上层收到数据后，在下一个时隙发送
     - 若时隙结束前未检测到冲突，节点可在下一个时隙发送新的帧
     - 若检测到冲突，节点在随后每一个时隙以概率 p 重传，直至发送成功
   - 优点
     - 单个活跃节点可以信道速率连续发送
     - 节点自行决定何时发送
     - 简单
   - 缺点
     - 发生冲突的时隙被浪费
     - 概率重传导致有些时隙被闲置
     - 需要时钟同步
   - 效率，假设 N 个活跃节点，每个节点在每个时隙开始时以概率 p 发送
     - 给定节点在要给时隙中发送成功概率 $p(1-p)^{N-1}$
     - 给定时隙中有节点发送成功概率 $Np(1-p)^{N-1}$
     - 可以计算得到最大效率 1/e

4. 纯 ALOHA
   - 基本思想：不需要时钟同步，有数据发送就可以立即发送，监听信道判断是否成功，不成功则以概率 p 重传，以概率 1-p 等待一个帧时再决定
   - 在时刻 t 发送的帧会与在 (t-1,t+1) 时段内发送的其他帧冲突
   - 给定节点发送成功概率为 $p(1-p)^{2(N-1)}$
   - 最大效率为 1/2e

5. 载波侦听多址接入 CSMA
   - 基本思想：发送前监听信道，若信道空闲则发送，否则推迟发送
   - 冲突仍可能发生
     - 存在传播延迟，节点可能没有监听到其他节点正在发送
     - 即使忽略传播延迟，也可能多个节点同时决定立即发送
   - 发生冲突时的处理
     - 继续发送 (浪费带宽)
     - 停止发送

6. CSMA/CD (Collision Detection)
   - 基本思想：若发送过程中检测到冲突，立即停止发送剩余部分，立即启动冲突解决的过程
   - 是早期以太网采用的 MAC 协议
   - 检测到冲突时，发送一个阻塞信号，加强冲突
   - 网卡进入指数回退阶段，选择一个等待时间；指数回退根据网络负载调整重传时间，负载越重，等待时间的选择范围越大，再次冲突的可能性越少
   - CSMA/CD 的效率：$T_{prop}$ 以太网中任意两个节点间传播延迟的最大值，$T_{trans}$ 最长帧的传输时间，则效率为 $\frac{1}{1+5T_{prop}/T_{trans}}$；则当 $T_{trans}$ 趋向于无穷或者 $T_{prop}$ 趋近于 0 时，效率趋近于 1；因此应控制以太网的规模

### 轮流 MAC 协议

1. 轮询
   - 主节点轮流邀请从节点发送，被邀请的从节点允许发送
   - 缺点：引入轮询延迟，单点失效 (主节点)

2. 令牌传递
   - 网络中有一个令牌，按预定顺序在节点间传递
   - 获得令牌的节点可以发送
   - 发送完数据后释放令牌
   - 缺点：令牌传递延迟，单点失效 (令牌)

## 局域网

1. 局域网、城域网和广域网
   - 局域网 Local Area Network，几公里以内，个人或机构所有
   - 城域网 Metropolitan Area Network，几十公里，服务质量好，支持用户数量多
   - 广域网 Wide Area Network，一百公里以上，覆盖要给国家或一个洲，规模和容量任意扩大

### 编址

1. 链路层编址
   - 每块网络适配器固定分配一个地址，称为物理、硬件、链路层、MAC 地址
   - MAC 地址长 6 个字节，用冒号或短横线分隔的 6 个十六进制数
   - MAC 地址是全球唯一的，由 IEEE 组织分配，网卡生产商购买一块 MAC 地址空间 (前 3 字节)，生产商确保生产的每块网卡有不同的 MAC 地址，地址固化在网卡的 ROM 中，但用软件改变网卡的 MAC 地址也是可能的

2. MAC 地址类型
   - 三种类型的 MAC 地址
     - 单播地址：网卡的 MAC 地址，地址最高比特为 0
     - 组播地址：标识一个多播组的逻辑地址，地址最高比特为 1
     - 广播地址：ff:ff:ff:ff:ff:ff
   - 网络适配器仅将发送给本节点的帧交给主机
     - 目的地址为适配器 MAC 地址的单播帧
     - 指定接收的多播帧
     - 所有广播帧
   - 若将适配器设置成混收模式，适配器将收到的所有帧交给主机

3. MAC 地址和 IP 地址
   - 先有 MAC 地址，后出现 IP 地址；在互联网出现之前，只使用 MAC 地址在单个物理网络中寻址
   - MAC 地址扁平结构，无法在互联网范围内快速确定接口位置；IP 地址有结构，可以快速确定接口位置
   - MAC 地址与网卡绑定，与节点在哪个子网无关；IP 地址与所在子网有关，与网卡没有关系

4. 将数据报发送到下一跳
   - 发送节点和接收节点位于同一物理网络上时，数据报可以直接交付
     - 发送节点的网络层将数据报、接收节点的 MAC 地址交给数据链路层
     - 发送节点的数据链路层将数据报封装在要给链路层帧中，设置帧的目的地址为接收节点的 MAC 地址，发送帧
     - 接收节点的适配器收到帧，根据目的 MAC 地址判断是发给本机的，取出数据报交给网络层

5. 地址解析 Address Resolution
   - 已知 IP 地址如何得到对应的 MAC 地址
   - 静态映射缺点：主机每次使用的 IP 地址可能不同
   - 主机可能更换网卡
   - 地址解析协议用于动态获得映射

6. ARP 基本思想
   - 若节点 A 希望获得节点 B 的 MAC 地址，节点 A 广播 B 的 IP 地址 (地址解析请求)
   - 节点 B 用自己的 MAC 地址进行响应

7. ARP 报文格式
   - 硬件类型：对以太网，值为 1
   - 协议类型：高层协议地址类型，对 IP 地址，值为 0x0800
   - 操作：ARP 请求为 1，ARP 响应为 2
   - 以太网上，ARP 报文封装在以太帧中传输

8. 地址解析过程
   - A 构造 ARP 请求，发送方字段填入自己的 MAC 地址和 IP 地址，在目标字段填入 B 的 IP 地址
   - A 将 ARP 请求封装在广播帧中发送
   - 每个收到的节点用目标 IP 地址与自己的 IP 地址比较，地址相符的节点进行响应
   - B 构造 ARP 响应，交换发送方与目标字段内容，在发送方硬件地址字段填入自己的 MAC 地址，修改操作字段为 2
   - B 将 ARP 响应封装在单播帧中发送，目的地址为 A 的 MAC 地址

9. 改进 ARP 的措施：ARP 缓存
   - 每个节点在内存中维护一个地址映射表
   - 每次发送数据报前先查询 ARP 缓存，若找不到则发送 ARP 请求，并在收到 ARP 响应后更新 ARP 缓存
   - ARP 缓存中的映射表项有时限，超时 (15~20 分钟) 后删除

10. 改进 ARP 的措施：主动学习
   - 从 ARP 请求中获取地址绑定信息：每个节点可以收到全部的 ARP 请求报文，将发送节点的地址映射缓存
   - 节点在启动时自动广播自己的地址映射，主动广播一个 ARP 请求，目标字段填入自己的 IP 地址，收到 ARP 请求的节点混存，若发送节点收到 ARP 响应，报告 IP 地址重复错误

### 以太网 Ethernet

1. 以太网
   - 第一个广泛应用的局域网技术，目前占主导地位的有线局域网技术
   - 与其他局域网技术相比，技术简单、成本低
   - 速率持续提高

2. 总线拓扑：共享式以太网
   - 总线 (1970s 中期)：同轴电缆作为共享传输媒体 (总线) 所有节点通过特殊接口连接到总线
   - 集线器 (1990s 后期)：物理层中继器，从一个端口进入的物理信号，放大后立即从其他端口输出，集线器相当于共享电缆

3. 星型拓扑：交换式以太网
   - 交换机 (21 世纪早期)：主机通过双绞线或光纤连接到交换机，主机与交换机为全双工链路，交换机在端口间存储转发帧
   - 星型拓扑：各节点仅与中心节点直接通信，各节点间不直接通信，不同于基于 hub 的星型连接
   - 交换式以太网不会产生冲突，不需使用 CSMA/CD 协议

4. 以太帧结构
   - 前导码 Preamble，7 个 10101010 字节，一个 10101011 字节，用于发送方和接收方间建立时钟同步，一般不计入以太帧长度
   - 目的/源 MAC 地址
   - 高层协议 2 字节
   - 数据 46~1500 字节，不足的填充至 46 字节
   - CRC 校验 4 字节，对目的/源地址、高层协议、数据计算得到

5. 无连接、不可靠的数据传输
   - 发送方与接收方网卡间没有握手
   - 接收方网卡不发送确认、接收方网卡丢弃 CRC 错误的帧、依靠上层协议进行错误回复

6. 最小帧长的要求：保证帧的发送时间足够长，以使发送方可以使用 CSMA/CD 协议在发送过程中检测冲突
   - 节点检测冲突需要时间
   - 帧的最小长度发送时间应不小于信号在相距最远的两个适配器间往返延迟

7. 802.3 以太网标准：链路层 & 物理层
   - 以太网技术链路层相同，物理层不同
   - 都由 IEEE 802.3 工作组标准化，形成 IEEE 802.3 标准族

8. DIX 以太帧与 802.3 帧
   - 最早提出的以太帧 DEC-Intel-Xerox 以太帧，type 字段指出处理 data 字段的协议实体
   - 符合 IEEE 802.3 标准的以太帧称为 802.3 帧，length 字段替代 type 字段，指出 data 字段的长度
   - 两种格式均可使用，type/length 值大于 1500 时解释为 type，否则解释为 length

9. 共享式以太网
   - 集线器所有端口位于同一个冲突域
   - 任意时刻最多一个主机发送给
   - 网络规模与网络性能矛盾无法解决

10. 交换式以太网
   - 交换机每个端口为一个冲突域
   - 多对端口可以同时通信
   - 网络集合带宽为各个端口带宽之和
   - 从根本上解决网络规模与网络性能的矛盾

11. 交换式以太网的最小帧长及规模
   - 交换式以太网不再 CSMA/CD 协议，理论上不需限制最小长度，为了向后兼容，帧格式和最小帧长度限制保持不变
   - 交换式以太网网络直径不再受信号最大往返时间限制
   - 交换式以太网的 MAC 层除了帧格式保持不变外，其他都和共享式以太网不同

### 交换机

1. 以太网交换机
   - 链路层设备：存储转发帧，检查输入帧的 MAC 地址，有选择地将帧转发到一条或多条输出链路
   - 对主机透明：交换机没有 MAC 地址，主机不需要了解有关交换机的任何信息
   - 即插即用，自主学习，交换机不需要配置

2. 交换机如何转发
   - 交换机内部有转发表，记录 MAC 地址和去往该地址的端口
   - 当帧到达交换机时，交换机从源 MAC 地址了解到发送节点，从到来的端口了解到发送节点的位置，将这些信息更新到转发表中
   - 如果目的地址在转发表中且输入端口不等于目的地址所在端口，交换机将帧转发到对应端口；如果目的地址在转发表中且输入端口等于目的地址所在端口，交换机丢弃帧
   - 如果目的地址不在转发表中，交换机将帧广播到除了输入端口的所有端口

3. 有环网络
   - 实际网络是有环网络，存在冗余链路，保证可靠性；但在有环网络中扩散帧会造成冗余传输，不能终止
   - 构造生成树，无环的网络拓扑，只使用无环拓扑来转发帧
   - 选举具有最小序列号的交换机作为生成树的根，根据根到各个交换机的最短路径构造生成树，只有位于生成树上的交换机可以在属于生成树的边上发送；出现故障时重新计算生成树

4. 交换机与路由器
   - 交换机工作于链路层，根据 MAC 地址转发帧；路由器工作于网络层，根据 IP 地址转发数据报
   - 交换机不能连接异构链路，只能按原样转发帧；路由器可以连接异构链路，路由器需要重新封装链路层帧
   - 交换机不能阻断广播帧的传播，只能学习到单播地址，所有广播帧都会扩散发送，通过交换机连接的所有主机在一个广播域中；路由器可以阻断广播帧的传播，路由器根据 IP 地址转发包，看不到 MAC 地址，每个路由器端口是一个独立的广播域

5. 广播域
   - 广播帧能到达的主机集合称广播域
   - 广播风暴：广播帧在网络中大量传播，消耗大量资源

6. 冲突域
   - 共享同一条广播链路的主机集合
   - 任何一个主机发送的帧，可被冲突域中的其他主机接收到

7. 三层交换机
   - 路由器可分隔两层网络，但转发速度慢，成本高
   - 三层交换机是具有部分路由器功能，又有二层转发速度的交换机，专为加快大型局域网内部数据交换设计，但在安全、协议支持等方面不如专用路由器
   - 机构网络中三层交换机用在机构网络的核心层，连接不同的子网或虚拟局域网，每个虚拟局域网是独立的子网；专用路由器连接机构网络与外网

8. 三层交换机转发速度快的原因：一次选路，多次转发
   - 路由器转发 IP 包的过程需要查找转发表，再用 ARP 获得下一跳 MAC 地址，再转发
   - 三层交换机以 IP 地址为索引构建哈希表，直接缓存 MAC 地址，在转发时直接查找哈希表，直接转发

## 连接的虚拟化

1. 早期的多个不连通的网络，有着不同的编址方法、包格式、差错恢复、选路

2. 在物理网络上增加一个逻辑层次 (IP 层)
   - 在逻辑层上统一编址、统一包格式
   - 互联在一起的网络看起来是一个网络
   - 用网关连接不同的物理网络
   - 在逻辑层上选路到下一个网关
   - 将 IP 包封装在本地网络帧中，发送到下一个网关

3. 两级编址：IP 网络，物理网络
   - IP 层提供统一的网络视图，地址、报格式
   - 物理网络对 IP 层透明，对 IP 层，物理网络只是虚拟链路
